#include <gtest/gtest.h>
#include "../../../Aesi.h"
#include "../../../Aesi-Multiprecision.h"
#include "../../benchmarks/benchmarks.h"

TEST(NumberTheory, PowerByModulo) {
    const auto timeStart = std::chrono::system_clock::now();

    {
        Aesi<256> b = "567572101034080205309651342998777317", p = "297984066927063188700878055519124646", m = "404818736618427895605379763906126248";
        EXPECT_EQ(Aesi<256>::powm(b, p, m), "182666762144093873740458481734649201");
    }
    {
        Aesi<256> b = "998768703011680273071786097456599575", p = "838719183048403110675655836166326299", m = "299696190112372209326961437583217431";
        EXPECT_EQ(Aesi<256>::powm(b, p, m), "288068419767832246270635192692632100");
    }
    {
        Aesi<256> b = "336456408630160900533549512247987136", p = "1248587571926291978959593107595237657", m = "648309516697674152971948494703831645";
        EXPECT_EQ(Aesi<256>::powm(b, p, m), "342048795736812234798237393335119506");
    }
    {
        Aesi<256> b = "914622560964721141493427459992503802", p = "763219652393220675205198670391678759", m = "430237715242853439053627172666944224";
        EXPECT_EQ(Aesi<256>::powm(b, p, m), "317650254686275561023962294519200192");
    }
    {
        Aesi<256> b = "1268916760840853298809823787329054222", p = "180973113846446321166664497121211451", m = "725715288027406622232457399087116006";
        EXPECT_EQ(Aesi<256>::powm(b, p, m), "147257091509176954426131091388189154");
    }
    {
        Aesi<256> b = "739748799134972105280587885776960570", p = "374259178181313322219152261747779832", m = "1317547854141801674067189843865389281";
        EXPECT_EQ(Aesi<256>::powm(b, p, m), "118273094801801927102290609402637169");
    }
    {
        Aesi<256> b = "481801615922442100257464371151014390", p = "116178865189292043368782719437895613", m = "888815380137097058825615103001743830";
        EXPECT_EQ(Aesi<256>::powm(b, p, m), "704914547540667683549083274460815110");
    }
    {
        Aesi<256> b = "213891809419059586269650697995286990", p = "239205021221667068048306224932980950", m = "307413653426687016222961491463595999";
        EXPECT_EQ(Aesi<256>::powm(b, p, m), "216335195445956514645489641017549279");
    }
    {
        Aesi<256> b = "16261504851869305191222225440261647", p = "613486208131019520782057825758758712", m = "1300414911115762793164221394710419151";
        EXPECT_EQ(Aesi<256>::powm(b, p, m), "341297668412692151171933963210103967");
    }
    {
        Aesi<256> b = "683928816373481423428744426290111792", p = "769875870630110531832229895167355557", m = "112918646288557667535576576144272708";
        EXPECT_EQ(Aesi<256>::powm(b, p, m), "4040468718105829451983915859094792");
    }
    {
        Aesi<256> b = "431122693523566469035943041277850522", p = "331638265143889161152421797881215050", m = "459954073315887393821781260618109227";
        EXPECT_EQ(Aesi<256>::powm(b, p, m), "314295149673166424777277606342885393");
    }
    {
        Aesi<256> b = "216681731926550509833580969318138121", p = "213639025647391699485675325836934950", m = "120888597348194426809276828942041873";
        EXPECT_EQ(Aesi<256>::powm(b, p, m), "99251907618050393999666762894848636");
    }
    {
        Aesi<256> b = "353365877311171025337974453038167482", p = "532525439689781546585505012663603902", m = "861377484159908158248610262999312907";
        EXPECT_EQ(Aesi<256>::powm(b, p, m), "414420046914662369954883502533346708");
    }
    {
        Aesi<256> b = "38094963576592760842299969233537698", p = "257991736481218916180183475563476471", m = "39592757717470104035137061802549155";
        EXPECT_EQ(Aesi<256>::powm(b, p, m), "16824517390095560686216650980057602");
    }
    {
        Aesi<256> b = "943156363090414771103156489542459730", p = "266402687154323589798964370904444134", m = "124506249547714908745479396139111029";
        EXPECT_EQ(Aesi<256>::powm(b, p, m), "69675975838328185976578300731318046");
    }
    {
        Aesi<256> b = "32348159896111353551278557698452121", p = "351831962750096628745196084807553289", m = "1131434265651623294422527905026158541";
        EXPECT_EQ(Aesi<256>::powm(b, p, m), "786284866700529729106717972983420984");
    }
    {
        Aesi<256> b = "808341467553486722539006187327192843", p = "1009106397684136359838378432494278682", m = "557381914688765421974873076415483704";
        EXPECT_EQ(Aesi<256>::powm(b, p, m), "123266924323935231025494069883455769");
    }
    {
        Aesi<256> b = "592548817422390740079205185329819816", p = "1176148706585967900425263973807735024", m = "178396324310660279122390901795113102";
        EXPECT_EQ(Aesi<256>::powm(b, p, m), "86180423494525298280198194832412116");
    }
    {
        Aesi<256> b = "556769364075128644512218688350625840", p = "265846140935516241301559164620444142", m = "742204900710401335678268288065380412";
        EXPECT_EQ(Aesi<256>::powm(b, p, m), "368186945165022391752850275803222032");
    }
    {
        Aesi<256> b = "548061049101635700037533890738112897", p = "878509262951597220615403188969003554", m = "1218953220570637031139681530171623326";
        EXPECT_EQ(Aesi<256>::powm(b, p, m), "1082145722968065276870199316893301073");
    }

#ifdef NDEBUG
    Logging::addRecord(testing::UnitTest::GetInstance()->current_test_info()->name(),
                       std::chrono::system_clock::to_time_t(timeStart),
                       (std::chrono::system_clock::now() - timeStart).count());
#else
    std::cout << "Time estimated: " << (std::chrono::system_clock::now() - timeStart).count() << " ms." << std::endl;
#endif /* NDEBUG */
}

TEST(NumberTheory, PowerByModuloDifferentPrecision) {
    {
        Aesi < 1088 > b = "28793048285076456849987446542225640606265293220424618926480394046852138561538086130369569608684063330929781666943229330417701929475565397707259833702883043470999551";
        Aesi < 512 > p = "115792089237316195423570984637466491971220643441904616453966139132392564064256";
        Aesi < 960 > m = "3121745573184599697933326506281725673488773347286281875230608438576618760350198733928207019107265771354178414155544146158372110284329493119107072";
        EXPECT_EQ(AesiMultiprecision::powm(b, p, m), "1286836696482081140314397122337047802239648832365860657790787629905517321601268779927276198715392010886217965690239863155957940369407301606440961");
    }
    {
        Aesi < 1024 > b = "13407807929942597099574024998205840962979609646775214065885217437705972534855967544372580674851683074864211086053989552841267536093376052211498616578637824";
        Aesi < 320 > p = "1461144825407731620530278796051549176363871109120";
        Aesi < 1088 > m = "57586096570152913699974892898380567793532123114264532903689671329430453039077084285042523271276718195461686303871834374018121798118265098455642255034105415086374911";
        EXPECT_EQ(AesiMultiprecision::powm(b, p, m), "42564106683845511631498521655651469549617377615639896347806059028514635640668676047385020376805556204505439186893523848592594858588418496205410276056718237776373363");
    }
    {
        Aesi < 832 > b = "169230328010303040104789128755083054127923732022899807468809113220112422547386864369054315593043409610121512739103191611736064";
        Aesi < 576 > p = "497323235483449955863837968976039649428411832473088307844669270716132876116016121249792";
        Aesi < 1152 > m = "247330401473104534060502521019647190023501929512482129665273875166691446055489595470830922917634503889644788508017545565362328433794782571145209373548919260370265165831077888";
        EXPECT_EQ(AesiMultiprecision::powm(b, p, m), "55563801833497614384214020422460598554623823483619729019925294819559150020877392844322847134219839231707844120715314831750084637976551028897860408786676578680286523449933824");
    }
    {
        Aesi < 960 > b = "3121748550315992231381597229793166305748598142664971150859156959625255946730528303924882532078483283251973661136740982331408518095280372176650240";
        Aesi < 384 > p = "6277101735386680763835789422575079056027526123990582034431";
        Aesi < 1152 > m = "247330401473104534060502521019647190035131349101211839914063056092897225106531867170316401061243044989597671426016139339351365034306751209967546155101893167916606772131921920";
        EXPECT_EQ(AesiMultiprecision::powm(b, p, m), "81719070410459849960569981916324100519056896839959044892894431146871324540741163585133503747046455790127428872500488867769790021865305550496403957465924800510614288444948480");
    }
    {
        Aesi < 1280 > b = "4562440617622195218641171605700291324893228507248169712010403018870352467554953240717694236549538278384784914953641235843336234018860399735369724823327235821862467883605650806576529468624470015";
        Aesi < 640 > p = "2135987035920910082395021706169551291856702963489018373226286118570173662888770803297219548020736";
        Aesi < 832 > m = "169230328010303641331690318839301489908704318298266917863074585613767653132821522082282056581704256758716025351527221690367999";
        EXPECT_EQ(AesiMultiprecision::powm(b, p, m), "86903993352159273726024218988856437095769082421817875105919859082069441199773555795349230693287571703209411791651700879814984");
    }
    {
        Aesi < 1024 > b = "13407807929942597099574024998205846127479365820592393377723561443721764030073546976801874298166903427690031858186486050853753882811946551499689575296532480";
        Aesi < 192 > p = "79228162514264337593536610303";
        Aesi < 960 > m = "3121748550315992231360443438791916829103813019291528218834738035592802360069254495148035631253882535571969826625245784523250285503002430152900607";
        EXPECT_EQ(AesiMultiprecision::powm(b, p, m), "167648241824788377642688807762960368919909878668492835130280239250424359095899275731967252385659208273069031431040545192513035811684446348615715");
    }
    {
        Aesi < 1088 > b = "57586096570152913699974892898380567793532123114264532903689671329431520511113834798455284506659101071783731920229799439845945850001882401931509362202255401183871999";
        Aesi < 512 > p = "115792089237316195323137357245424007756186726618908221633794085042696929411079";
        Aesi < 1088 > m = "57586096570152913699974892898380567793532123114264532903689671329431521032595044740083720782129802971518987656109067457577065805510327036016891142675844838996312064";
        EXPECT_EQ(AesiMultiprecision::powm(b, p, m), "39425654526107845777534757940252133690690500017817066812291843029593672275529926593423190550750419392824945760638655783123482275062105795307978947593311022434229247");
    }
    {
        Aesi < 1216 > b = "1062275985633534197379176413104937254659186235454063846398888276400807119721704485478325004530458571337778658972493002030693158675305414478819039957533174703887662541670777916848340992";
        Aesi < 640 > p = "2135987035920910082395021706166182121269310692382319393235388725851535576021070777467889459920895";
        Aesi < 1088 > m = "57586096570152913699974892898198858112458221391627201951717670195843110692423215225013348232334643149490638175301464937724654427531985572965205873684212146126192640";
        EXPECT_EQ(AesiMultiprecision::powm(b, p, m), "52805426313587856528879255792073388076887345584000467946817726849023223060397538582575761013521794712684325354210839369723119298304221565695114180849032759143825408");
    }
    {
        Aesi < 1088 > b = "57586096570152913699974892898369211025110932197875125602495188346570005377472866204388234174818635354569564200889698953789765988726003027997523531343887529083404287";
        Aesi < 320 > p = "1461501637330902918202446892677015653779542900224";
        Aesi < 896 > m = "726838724295606890549323807886857785319052665529389133028993772601213061236285265346505431407524514935530011739795894737435778042822656";
        EXPECT_EQ(AesiMultiprecision::powm(b, p, m), "601472881595829681311768882757452224394957009400235631029169398952722344346849528336215179275540154188455637790277240554377393333075969");
    }
    {
        Aesi < 1088 > b = "57586096570152913699974892898380567790824437866099674642382626227729290853457899158662024907939881506075021535205136185077090799549253229283575389860596013917536255";
        Aesi < 640 > p = "2135987035920910082395021706169552114602704522356652769947041607822219725780640550022962086936575";
        Aesi < 1216 > m = "1062275985633534197379176413104937254659186235454063846398882987953056797732912870155929093947289413222951585417336150507998249973690913492664547841982744437630392702545436270131150847";
        EXPECT_EQ(AesiMultiprecision::powm(b, p, m), "283134526851189100852240159489524993577982883156885921970936798893693737332300616573823900258478833841330461507282794088468469403324860657710499652143142023883259032958999851114066538");
    }
    {
        Aesi < 1216 > b = "1062275985633534197379176413098233350694217985486845501860948811928112156625225383756074256777023821120951484760158914493906870028350298551175190050077976241237449780259849816638488576";
        Aesi < 512 > p = "115792089237316195411016781724986755903953896272547229400021678868641165213680";
        Aesi < 1216 > m = "1062275981676247773809503868136896918344831194891962260779498837775798222235348883782564132704528202055379948047400744675847606966191432593882325306975554164754257180661652547409281024";
        EXPECT_EQ(AesiMultiprecision::powm(b, p, m), "367212410660349293556324601728065904864465591684104661804455312007376321346007876135761176000158090074118654491979754235578022146043364297442338651781033978643260258822572193433518080");
    }
    {
        Aesi < 960 > b = "3121748550315992231381597229793166305748598142664971150859156959625364501814188287858092129876928928165586101747365020360195509581413690642530303";
        Aesi < 320 > p = "1461490486963620564874634758333721921125397561407";
        Aesi < 1024 > m = "13407807929942597099574024998205846127479365820592393360225555645457668635093529159860903375341547980544332366780321199574129889216939184158328232821653504";
        EXPECT_EQ(AesiMultiprecision::powm(b, p, m), "7558784404007254179446202013527355286311652987153519874299029622893115829321653711359187394756810497438550966453777044499316481698080147321408978876891135");
    }
    {
        Aesi < 768 > b = "39402006196394474837777590534119765060075285035223558459942780075314432264177467154966809113375959303628109239026687";
        Aesi < 576 > p = "497323236409786642155375666128591555276287530920617488043514648350609880299066793918463";
        Aesi < 1088 > m = "57586096570152913699974892898380567793532123113003668714652434414310560084205278948179183670766658714471158035184897947977991938123264469667722602304733233878663167";
        EXPECT_EQ(AesiMultiprecision::powm(b, p, m), "53750455023425484251590451536225101504065350384994488259671724003959955961949211487858823711077412591697854622831147179340278924737999949165432908832771319540000734");
    }
    {
        Aesi < 1280 > b = "4562440617622195218641171603857536234648335268849363357831014348506247558079881512662571649039502557186432406335067778684252157262718916566987175660155911237399442436210624017667798014472740864";
        Aesi < 640 > p = "2135986017402921915152204728370999543107810658702551030548942207690795127816630233948373376827392";
        Aesi < 1152 > m = "247330401444311485775426064169659743585941065205122699668893200193986361758817106118602877866534999448796070226567555134413719075795233475073408356551927274789783246120943615";
        EXPECT_EQ(AesiMultiprecision::powm(b, p, m), "71264946182442896501111445551292324403933274599945950715454908540527922469326567258770589455295819618860258960659949847068266956542322357308123242207639532834185396056696466");
    }
    {
        Aesi < 1280 > b = "4562440617622195218641171605700291269974847226203682213701117539962914098952224014513569647584321690996277108355474989175092994780793822144284304711061489162472004594364639851026124360325783552";
        Aesi < 320 > p = "1461501637325586006220545169224667791414811230207";
        Aesi < 896 > m = "726838724295606890549323807888004534353641360687318060281490199180639288113397923326191050713763565560762521606115062206082772981776384";
        EXPECT_EQ(AesiMultiprecision::powm(b, p, m), "573085401894547166516877089750418966107279455078782547574800402627962088464692182111276871789969819688769511207932354915166690109030400");
    }
    {
        Aesi<864> b = "11090678776483259438313656736572334813745740344331483744095643836342514882089060884861484872297597135700949968707655805690179485695";
        Aesi<256> p = "340282366920938463463374607430694469632";
        Aesi<672> m = "139984046386112763159838289862099970323476066441406953502400293335070582272926757986317508127144017920";
        EXPECT_EQ(AesiMultiprecision::powm(b, p, m), "69079484759223978771725604820876564626247001712169147692709103033711794245882473503725969639949205505");
    }
    {
        Aesi<768> b = "39402006196394479212279039590884619721458231838130542792678389807758629298361274489173579184684013616334120517894144";
        Aesi<128> p = "18167520626212866175";
        Aesi<736> m = "601226901190101306339707032778070279008174732520529886116452717031736444463277932798047865154700400216954896384";
        EXPECT_EQ(AesiMultiprecision::powm(b, p, m), "166447213589684059641991998731395753952867333867023648121519053118548941940730378205117569499309680382883135488");
    }
    {
        Aesi<736> b = "601226901190101306339707032778070279008174732520529886901066488712245510429339599267430114963433206756870717439";
        Aesi<128> p = "9223510592466305031";
        Aesi<832> m = "169230328005378390557158926912791928617237135317019459417751424189778811413571839323317524417207459349096616339035945982496767";
        EXPECT_EQ(AesiMultiprecision::powm(b, p, m), "163571374596502077158450643805430090015294226721581258074063672607038855306387274368353843169596610829477792365728343013827463");
    }
    {
        Aesi<736> b = "601226901190101306339707032778069815839817783676997359291355200569599889047518065525993786130227286043797749760";
        Aesi<256> p = "340282366920937896779396662524586754048";
        Aesi<800> m = "2582249878086908589655919172003011874329705792829223512830659356540647622016841194629645353280137831435903171972479057920";
        EXPECT_EQ(AesiMultiprecision::powm(b, p, m), "2579701408596237953229338966783854517127482461408021202063410591513655437652750417878791830806844428048643028427032494080");
    }
    {
        Aesi<704> b = "9173924471937092994040168135609609028485434160723415743258425125724447672427269041667050124299132165160960";
        Aesi<256> p = "170141183460469533963142207355997913103";
        Aesi<768> m = "39402006196394479212279040100143613805079739270465446667948293404245721771497209282186270469969042736999567709962240";
        EXPECT_EQ(AesiMultiprecision::powm(b, p, m), "5482278480730755497604397215387492614088698182310191625462706667534436415097143802580027802613073006276679523368960");
    }
}

TEST(NumberTheory, PowerByModuloHuge) {
    const auto timeStart = std::chrono::system_clock::now();

    {
        Aesi<2048> b = "6830171368312288096475908992405588501389780043799306084349131369952807274139586731773092160775146076312263272393170577747518778448948163309509561003089707902453708458796000467268431451552569515654251657999779243061161220652165286993066871166534158075697454405543156721108200637842315713915207460883998684249",
        p = "102618672105036018644968797310246279513453448452020833987356615341017262261890796129357088577082418514014678547486176373518826555460073808288739474503394162621645188677442688997297349313621476640613824248811265299373932191159668022903457609442812601652761472717901164634182128574535238693392969025882643988432",
        m = "130867420213148255042714304040581763908284083990870492540583938432666213785455334578503359216899680520648339815937677146332390945201160603659087503407954102331629293108006611414812322100821131413783243481182824097205519281079779111825441360293552432745125461715677860177902708485952079170032728993896531326027";
        EXPECT_EQ(Aesi<2048>::powm(b, p, m), "52243375550600445155490601836045351615978014701779721243138435858058893432023032638723274043428422989232936398439091961339335905031983551857362264380894936663357945140415783629514549942874263662259394183281446759483780345247637517637452710564976718010235099070969606092324131094175192186382905483645573245602");
    }
    {
        Aesi<2048> b = "89342520850149391279781763065175497997799439042694887521488341840168289823378481153406686518566784851530290977706002891345301027701629460091769942102784041539443462174931393769167927716456271590787466058738098799785252366526923514122181316794118689102831716623007794643968544213836774314065077176589415454713",
        p = "172348137581825939131557498016944655699287488650842375126394034719939792791876600290688961376466654855754348508717790551064020615907030648456853246168332586932013431591495309132023845328615222128885553255599780035206386314890185046511157482779540682679353948800415683372589469079188515314299327533043124762522",
        m = "80376298267965148987701210413571813727191584104544066222598799068314380725267073476121338604608526213965351335218677209931198366148446803528102324729792026025390352726490334052957136030865095958124323772518251406129973996022020458270379379625731238261333146331815633399103172933604944123608781047950959087937";
        EXPECT_EQ(Aesi<2048>::powm(b, p, m), "69782059039933138373313852634942506739708198882244799961220725681282118607233402914675259134464708458652818062327228324806386796587686370016083700999732734781593855336812067801051438860870487794796422319477005536489828135113902061396077788150231583472902114492789799655511373998160571226880028296654558107650");
    }
    {
        Aesi<2048> b = "99724623666340957739704577056778080532316964209499948225230569089343873610412513871684491912958410308829588608437510975444301976165083135895418285519699666793572500288683191785597691138288856363254718418098118143906874086168900543721517398708223602449102301791041440791957466665726860410409912744816331851748",
        p = "156604441907158450291968029730220494179790131902927254260859143898381978964924076547870523846077645335826068815540777991648535336382091338254327745634369206274042304645955833269398717951314546465269899286119009105105487103980932695223350757826022471838454332046422011775948936155832110851363852386625884358706",
        m = "98571318015400747842564192332799053567569453599401455773627074084850868231795947546951416858272568683594554778692778467220589231030331007944769485915791089577472159613785679495176586625545823782814414822157201505741667291856235224086456801948648090232369172682767586162503323504842222411825167971699351769567";
        EXPECT_EQ(Aesi<2048>::powm(b, p, m), "42463783697895964944158666384865788858038502027323828496598667402929250067168996381491020564989331222054291100770992698155432201077087584226113306880326436599000071205989494600994409708534444876911455704745731075583199081680527032768537509337980846684399073762563987564876085822718988694619038521045268926684");
    }
    {
        Aesi<2048> b = "106559103524847723378070937142290397017307511637358713827456814630485158326504801331424853897275428926375297164042147314868119680513634277062010961546769382645129815866563407154539245010248815340751474894630422779705207550573316490832948477980717315178369216976920854708881156538536207095381387422029051837118",
        p = "122711914532141126803954995228153583168149388551858774426009988033725311162173090963083670370843867749885520764642916367133366434001474600256655387495210177039242749318326041097310895547505334241086756403285148575575132006973137768256062596355408175353602333306622835452726314049505305567805249079551144415109",
        m = "88690060370356778353509554993117118447221503121943201116582692867719571746928765343001623476589995283482223397461140486693744917574312134585589580269211776230389259841452415627936017533569138057983507895524992393416826303214870738569022975283682930055428981055369993363456993040153065352684531730854159903129";
        EXPECT_EQ(Aesi<2048>::powm(b, p, m), "60821044764354250284980047790991056308928712482556004973284249455737637292159231377967006527214750678953768957902512891249267919108356433914337879736217652551053634026612712449002594266664446215252862488738804919626585404642095140893585511259348928442950991804870670553903243180551340789989627193842262336513");
    }
    {
        Aesi<2048> b = "100390334490704871264490303982857535551939147625656138296880409745490328743072380338532486073571894609977468394128716739168566875609252841551557646784730733624127565556376333319921922456032008935318182356095201116958971713268270951570877960802787998446250788116142601752248389500322357777128411129744695325757",
        p = "175303281932978985001521673033089056622393657993890048682003837386051264756294248143414070803811013236893489961293698949141846922154401295990243988705997568663871776719181741028388646126074617770998842064763945416386610681863106124454447788432851464858343086686544127386163910348287904948894585367950434543409",
        m = "37091626457153802785754172645346827847419346326447719185887484113000823773299446368316933239049144716096930779015470924622016211624151240435807303312173996281773734110083926659121147442434350597676236347024495902689227626924961429462336991554823366237418085476944029292968917582674112246916639629128589127231";
        EXPECT_EQ(Aesi<2048>::powm(b, p, m), "6718546365501856191364734478512326699043874046505170587904327645452500015908127918042494970607515560751554256929445522143846790003020958133962511415991221245181925669366545168800595189568652808832173565039535084745369880301927229861467434718170000570941689789006007219462125660600295170823842399173353279811");
    }

#ifdef NDEBUG
    Logging::addRecord(testing::UnitTest::GetInstance()->current_test_info()->name(),
                       std::chrono::system_clock::to_time_t(timeStart),
                       (std::chrono::system_clock::now() - timeStart).count());
#else
    std::cout << "Time estimated: " << (std::chrono::system_clock::now() - timeStart).count() << " ms." << std::endl;
#endif /* NDEBUG */
}